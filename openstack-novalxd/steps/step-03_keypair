#!/bin/bash

# Path to executing script
SCRIPT=$(realpath $0)

# Directory housing script
SCRIPTPATH=$(dirname $SCRIPT)

. $SCRIPTPATH/share/common.sh

_ssh_public_key=$(expandPath $SSHPUBLICKEY)
debug "Environment Variables: $_ssh_public_key"

tmpfile=$(mktemp)

cat <<EOF> $tmpfile
sudo apt update > /dev/null 2>&1
sudo apt -qyf install python3-openstackclient > /dev/null 2>&1
export SSHPUBLICKEY=$_ssh_public_key
EOF

$SCRIPTPATH/share/novarc >> $tmpfile
cat $SCRIPTPATH/share/common.sh >> $tmpfile
cat $SCRIPTPATH/share/keypair.sh >> $tmpfile


if [ ! -f $_ssh_public_key ]; then
    debug "Couldnt find $_ssh_public_key, attempting to create one"
    ssh-keygen -N '' -f ${_ssh_public_key%%.*}
    debug "ssh-keygen result: $?"
fi

debug "Creating .ssh directory on controller node"
juju ssh -m $JUJU_CONTROLLER:$JUJU_MODEL nova-cloud-controller/0 "mkdir -p ~/.ssh && chmod 700 ~/.ssh"

debug "SCPing over $_ssh_public_key to controller node"
juju scp -m $JUJU_CONTROLLER:$JUJU_MODEL $HOME/.ssh/id_rsa.pub nova-cloud-controller/0:.ssh/id_rsa.pub
debug "scp result: $?"

juju scp -m $JUJU_CONTROLLER:$JUJU_MODEL $tmpfile nova-cloud-controller/0:keypair.sh
juju ssh -m $JUJU_CONTROLLER:$JUJU_MODEL nova-cloud-controller/0 "bash keypair.sh"
